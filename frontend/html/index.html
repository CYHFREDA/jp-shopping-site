<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>日本代購商城</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="text-center mb-4">日本代購商城 - 新增商品</h1>

  <table class="table table-bordered bg-white shadow-sm" id="productTable">
    <thead class="table-success">
      <tr>
        <th>商品名稱</th>
        <th>數量</th>
        <th>價格</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" class="form-control" placeholder="商品名稱"></td>
        <td><input type="number" class="form-control" value="1" min="1"></td>
        <td><input type="number" class="form-control" value="100" min="0"></td>
        <td><button class="btn btn-danger" onclick="removeRow(this)">刪除</button></td>
      </tr>
    </tbody>
  </table>

  <div class="text-center mt-3">
    <button class="btn btn-primary me-2" onclick="addRow()">➕ 新增商品</button>
    <button class="btn btn-success" onclick="startPayment(event)">綠界支付</button>
  </div>

  <div class="text-center mt-4">
    <a href="/backend.html" class="btn btn-dark">後台管理</a>
  </div>
</div>

<script>
  function addRow() {
    const table = document.getElementById("productTable").getElementsByTagName('tbody')[0];
    const newRow = table.rows[0].cloneNode(true);
    newRow.querySelectorAll("input").forEach(input => {
      if (input.type === "text") input.value = "";
      if (input.type === "number") input.value = 1;
    });
    table.appendChild(newRow);
  }

  function removeRow(button) {
    const row = button.closest("tr");
    const table = document.getElementById("productTable").getElementsByTagName('tbody')[0];
    if (table.rows.length > 1) {
      row.remove();
    } else {
      alert("⚠️ 至少要留一筆商品喔！");
    }
  }

  function startPayment(event) {
    event.preventDefault();

    const rows = document.querySelectorAll("#productTable tbody tr");
    const products = [];

    rows.forEach((row) => {
      const name = row.cells[0].querySelector("input").value || "未命名商品";
      const quantity = parseInt(row.cells[1].querySelector("input").value) || 1;
      const price = parseInt(row.cells[2].querySelector("input").value) || 0;
      if (price > 0) {
        products.push({ name, quantity, price });
      }
    });

    if (products.length === 0) {
      alert("❌ 請至少輸入一個有效商品！");
      return;
    }

    fetch("/pay", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ products })
    })
    .then(res => res.json())
    .then(data => {
      if (data.ecpay_url && data.params) {
        const form = document.createElement("form");
        form.action = data.ecpay_url;
        form.method = "post";
        Object.entries(data.params).forEach(([key, value]) => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = key;
          input.value = value;
          form.appendChild(input);
        });
        document.body.appendChild(form);
        form.submit();
      } else {
        alert("❌ 發起付款失敗！");
      }
    })
    .catch(err => {
      alert("❌ 發起付款錯誤！");
      console.error(err);
    });
  }
</script>
</body>
</html>
