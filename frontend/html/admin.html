<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>後台訂單管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<!-- 導覽列 -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="/index.html">🔙 回到商城首頁</a>
    <span class="navbar-text text-white">｜後台訂單管理</span>
  </div>
</nav>

<div class="container py-4">
  <!-- 登入區塊 -->
  <div id="loginArea" class="mb-4">
    <h4>請輸入後台帳號密碼：</h4>
    <input id="username" class="form-control mb-2" placeholder="Username" />
    <input id="password" type="password" class="form-control mb-2" placeholder="Password" />
    <button class="btn btn-primary" onclick="login()">登入</button>
  </div>

  <!-- 訂單管理區塊 -->
  <div id="ordersArea" class="d-none">
    <div id="ordersTable" class="table-responsive"></div>
  </div>
</div>

<script>
  let token = "";

  function login() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    if (!username || !password) {
      alert("請輸入完整帳號密碼");
      return;
    }

    token = btoa(`${username}:${password}`);
    loadOrders();
  }

  async function loadOrders() {
    const res = await fetch("/admin/orders", {
      headers: { "Authorization": "Basic " + token }
    });
    if (!res.ok) {
      alert("❌ 帳號或密碼錯誤！");
      return;
    }
    const orders = await res.json();

    let html = `
      <table class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            <th>訂單編號</th>
            <th>商品內容</th>
            <th>金額</th>
            <th>狀態</th>
            <th>建立時間</th>
            <th>付款時間</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
    `;

    orders.forEach(o => {
      html += `
        <tr>
          <td>${o.order_id}</td>
          <td>${o.item_names}</td>
          <td>${o.amount}</td>
          <td>${o.status}</td>
          <td>${o.created_at}</td>
          <td>${o.paid_at || '-'}</td>
          <td>
            <select onchange="updateStatus('${o.order_id}', this.value)" class="form-select form-select-sm">
              <option value="">--修改狀態--</option>
              <option value="pending">pending</option>
              <option value="success">success</option>
              <option value="fail">fail</option>
            </select>
          </td>
        </tr>
      `;
    });

    html += "</tbody></table>";
    document.getElementById("ordersTable").innerHTML = html;

    // 切換畫面：隱藏登入、顯示訂單
    document.getElementById("loginArea").classList.add("d-none");
    document.getElementById("ordersArea").classList.remove("d-none");
  }

  async function updateStatus(orderId, newStatus) {
    if (!newStatus) return;

    const res = await fetch("/admin/update_order_status", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Basic " + token
      },
      body: JSON.stringify({ order_id: orderId, status: newStatus })
    });
    const result = await res.json();
    alert(result.message || result.error);
    loadOrders();
  }
</script>

</body>
</html>
