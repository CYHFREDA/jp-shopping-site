<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>日本代購商城</title>
<style>
  body {
    font-family: "Helvetica Neue", sans-serif;
    text-align: center;
    background-color: #f0f4f8;
    margin: 0;
    padding: 50px;
    color: #333;
  }

  h1 {
    color: #222;
    margin-bottom: 30px;
  }

  table {
    margin: 0 auto;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  th, td {
    border: 1px solid #ddd;
    padding: 10px 15px;
  }

  th {
    background-color: #00c300;
    color: white;
  }

  tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  input[type="text"], input[type="number"] {
    width: 100px;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
    text-align: center;
  }

  button {
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #00c300;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: background-color 0.3s, transform 0.2s;
  }

  button:hover {
    background-color: #00a300;
  }

  #addRowBtn {
    background-color: #007bff;
  }

  #addRowBtn:hover {
    background-color: #0056b3;
  }
</style>
</head>
<body>

<h1>日本代購商城 - 新增商品</h1>

<table>
  <thead>
    <tr>
      <th>商品名稱</th>
      <th>數量</th>
      <th>價格</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody id="productTable">
    <tr>
      <td><input type="text" placeholder="商品名稱" /></td>
      <td><input type="number" value="1" min="1" /></td>
      <td><input type="number" value="100" min="0" /></td>
      <td><button onclick="removeRow(this)" style="background: #dc3545;">刪除</button></td>
    </tr>
  </tbody>
</table>

<button id="addRowBtn" onclick="addRow()">➕ 新增商品</button>
<button onclick="startPayment(event)">LINE Pay 支付</button>

<script>
  function addRow() {
    const table = document.getElementById("productTable");
    const newRow = table.rows[0].cloneNode(true);
    // 清空新列的值
    newRow.querySelectorAll("input").forEach(input => {
      if (input.type === "text") input.value = "";
      if (input.type === "number") input.value = 1;
    });
    table.appendChild(newRow);
  }
  
  function removeRow(button) {
    const row = button.closest("tr");
    const table = document.getElementById("productTable");
    if (table.rows.length > 1) {
      row.remove();
    } else {
      alert("⚠️ 至少要留一筆商品喔！");
    }
  }
  
  function startPayment(event) {
    event.preventDefault();
  
    const rows = document.querySelectorAll("#productTable tr");
    const products = [];
  
    rows.forEach((row, idx) => {
      const name = row.cells[0].querySelector("input").value || "未命名商品";
      const quantity = parseInt(row.cells[1].querySelector("input").value) || 1;
      const price = parseInt(row.cells[2].querySelector("input").value) || 0;
  
      console.log(`第${idx+1}列：名稱=${name}，數量=${quantity}，價格=${price}`);
  
      // ✅ 只把價格>0的商品推進去
      if (price > 0) {
        products.push({ name, quantity, price });
      }
    });
  
    console.log("組合後的商品陣列：", products);
  
    if (products.length === 0) {
      alert("❌ 請至少輸入一個有效商品！");
      return;
    }
  
    // 🔥 修正 fetch：確保請求 header 和 body 正確
    fetch("https://api.wvwwcw.xyz/pay", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      // 🔥 把 body 改成 JSON.stringify
      body: JSON.stringify({ products })
    })
    .then(res => {
      if (!res.ok) {
        // 顯示錯誤
        return res.json().then(err => { throw err; });
      }
      return res.json();
    })
    .then(data => {
      console.log("後端回傳：", data);
      if (data.url) {
        // ✅ 如果後端有回傳付款連結，直接跳轉
        window.location.href = data.url;
      } else {
        alert("❌ 發起付款失敗！");
        console.error(data);
      }
    })
    .catch(err => {
      alert("❌ 發起付款錯誤！");
      console.error(err);
    });
  }
  </script>
  

</body>
</html>