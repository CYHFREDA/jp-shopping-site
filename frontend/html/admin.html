<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>後台管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" data-href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" data-href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="css/admin.css" data-href="css/admin.css">
</head>

<body>
<!-- 🔹 頁首導覽列 -->
<nav class="navbar navbar-expand-lg navbar-light bg-warning border-bottom shadow-sm">
  <div class="container-fluid">
    <!-- 左邊 -->
    <a class="navbar-brand fw-bold" href="/index.html"><i class="fas fa-store"></i> 商城首頁</a>

    <!-- 右邊 -->
    <div class="ms-auto d-none" id="adminHeader">
      <span class="navbar-text text-light me-3">後台管理系統</span>
      <button id="logoutBtn" class="btn btn-danger btn-sm">登出</button>
    </div>
  </div>
</nav>

<!-- 🔹 登入畫面 -->
<div id="loginArea" class="container mt-5">
  <div class="card p-4 text-center">
    <h4 class="card-title mb-3">後台登入</h4>
    <p class="text-muted mb-4">請輸入您的帳號與密碼以登入後台</p>
    <div class="row justify-content-center mb-2">
      <div class="col-md-4">
        <input id="username" class="form-control form-control-lg" placeholder="Username">
      </div>
    </div>
    <div class="row justify-content-center mb-3">
      <div class="col-md-4">
        <input id="password" type="password" class="form-control form-control-lg" placeholder="Password">
      </div>
    </div>
    <div class="row justify-content-center">
      <div class="col-md-4">
        <button class="btn btn-primary btn-lg w-100" onclick="login()">登入</button>
      </div>
    </div>
  </div>
</div>

<!-- 🔹 主畫面 -->
<div id="adminArea" class="d-none container mt-4">
  <!-- 上方橫向選單 -->
  <ul class="nav nav-tabs mb-3" id="adminNav">
    <li class="nav-item"><a class="nav-link active" data-target="ordersArea" href="#">📦 訂單管理</a></li>
    <li class="nav-item"><a class="nav-link" data-target="shippingArea" href="#">🚚 出貨管理</a></li>
    <li class="nav-item"><a class="nav-link" data-target="customersArea" href="#">👥 客戶管理</a></li>
    <li class="nav-item"><a class="nav-link" data-target="productsArea" href="#">🛍️ 商品管理</a></li>
  </ul>

  <!-- 🔹 各區塊 -->
  <div id="ordersArea" class="card p-4">
    <h5 class="card-title mb-3">📦 訂單管理</h5>
    <div id="ordersTable" class="table-responsive"></div>
  </div>

  <div id="shippingArea" class="card p-4 d-none">
    <h5 class="card-title mb-3">🚚 出貨管理</h5>
    <div id="shippingTable" class="table-responsive"></div>
  </div>

  <div id="customersArea" class="card p-4 d-none">
    <h5 class="card-title mb-3">👥 客戶管理</h5>
    <div id="customersTable" class="table-responsive"></div>
  </div>

  <div id="productsArea" class="card p-4 d-none">
    <h5 class="card-title mb-3">🛍️ 商品管理</h5>
    <div class="row g-2 mb-3">
      <div class="col-md-3"><input id="productName" class="form-control" placeholder="商品名稱"></div>
      <div class="col-md-2"><input id="productPrice" type="number" class="form-control" placeholder="價格"></div>
      <div class="col-md-4"><input id="productDesc" class="form-control" placeholder="商品描述"></div>
      <div class="col-md-3"><input id="productImage" class="form-control" placeholder="圖片網址 (可空)"></div>
      <div class="category-checkboxes mb-3">
        <label><input type="checkbox" value="flashsale" class="category-checkbox"> 限時搶購</label>
        <label><input type="checkbox" value="sale" class="category-checkbox"> 限定SALE</label>
        <label><input type="checkbox" value="japan_medicine" class="category-checkbox"> 日本藥品</label>
        <label><input type="checkbox" value="food_drink" class="category-checkbox"> 食品/飲料/酒</label>
        <label><input type="checkbox" value="beauty" class="category-checkbox"> 美妝/美髮/肌膚護理</label>
        <label><input type="checkbox" value="men" class="category-checkbox"> 男士用品</label>
        <label><input type="checkbox" value="home" class="category-checkbox"> 生活家用/沐浴&身體</label>
        <label><input type="checkbox" value="baby" class="category-checkbox"> 親子育兒</label>
      </div>
    </div>
    <button class="btn btn-success w-100 mb-3" onclick="addProduct()">新增商品</button>
    <div id="productsTable" class="table-responsive"></div>
  </div>
</div>

<footer class="mt-5">&copy; 2025 日本代購商城管理系統</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let token = "";
  
  // 登入與驗證
  async function login() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;
    if (!username || !password) { alert("請輸入完整帳號密碼！"); return; }
    token = btoa(`${username}:${password}`);
    localStorage.setItem("basic_token", token);
    localStorage.setItem("expire_at", Date.now() + 30 * 60 * 1000);
  
    const res = await fetch("/admin/orders", { headers: { "Authorization": "Basic " + token } });
    if (!res.ok) { alert("❌ 帳號或密碼錯誤！"); token = ""; return; }
    document.getElementById("loginArea").classList.add("d-none");
    document.getElementById("adminArea").classList.remove("d-none");
    document.getElementById("adminHeader").classList.remove("d-none");
    loadOrders();
  }
  
  // 初始化檢查
  window.onload = () => {
    const savedToken = localStorage.getItem("basic_token");
    const expireAt = localStorage.getItem("expire_at");
    if (savedToken && expireAt && Date.now() < parseInt(expireAt)) {
      token = savedToken;
      document.getElementById("loginArea").classList.add("d-none");
      document.getElementById("adminArea").classList.remove("d-none");
      document.getElementById("adminHeader").classList.remove("d-none");
      loadOrders();
    }
  };
  
  // 分頁切換
  document.querySelectorAll("#adminNav .nav-link").forEach(link => {
    link.addEventListener("click", function() {
      document.querySelectorAll("#adminNav .nav-link").forEach(l => l.classList.remove("active"));
      this.classList.add("active");
      const target = this.getAttribute("data-target");
      document.querySelectorAll("#adminArea > div").forEach(area => area.classList.add("d-none"));
      document.getElementById(target).classList.remove("d-none");
      if (target === "ordersArea") loadOrders();
      if (target === "productsArea") loadProducts();
    });
  });
  
  // 新增商品
  async function addProduct() {
    const name = document.getElementById("productName").value.trim();
    const price = parseInt(document.getElementById("productPrice").value);
    const description = document.getElementById("productDesc").value.trim();
    const image_url = document.getElementById("productImage").value.trim();
    const checkedCategories = Array.from(document.querySelectorAll(".category-checkbox:checked")).map(cb => cb.value);
    const category = checkedCategories.join("#");
  
    if (!name || !price) { alert("請填寫完整商品名稱與價格！"); return; }
    if (category.length > 255) { alert("❌ 分類超過 255 字元限制，請刪減分類！"); return; }
  
    const res = await fetch("/admin/products", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Basic " + token },
      body: JSON.stringify({ name, price, description, image_url, category })
    });
    const result = await res.json();
    alert(result.message || result.error);
    loadProducts();
  }
  </script>
  <script src="js/cache-busting.js"></script>

</body>
</html>
