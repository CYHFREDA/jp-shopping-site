<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>å¾Œå°ç®¡ç†</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="/index.html">ğŸ”™ å›åˆ°å•†åŸé¦–é </a>
    <span class="navbar-text text-white">ï½œå¾Œå°ç®¡ç†</span>
  </div>
</nav>

<div class="container py-4">
  <!-- ç™»å…¥ -->
  <div id="loginArea" class="mb-4">
    <h4>è«‹è¼¸å…¥å¾Œå°å¸³è™Ÿå¯†ç¢¼ï¼š</h4>
    <input id="username" class="form-control mb-2" placeholder="Username" />
    <input id="password" type="password" class="form-control mb-2" placeholder="Password" />
    <button class="btn btn-primary" onclick="login()">ç™»å…¥</button>
  </div>

  <!-- è¨‚å–®ç®¡ç† -->
  <div id="ordersArea" class="d-none mb-5">
    <h4>è¨‚å–®ç®¡ç†</h4>
    <div id="ordersTable" class="table-responsive"></div>
  </div>

  <!-- å•†å“ç®¡ç† -->
  <div id="productsArea" class="d-none">
    <h4>å•†å“ç®¡ç†</h4>
    <div class="mb-3">
      <input id="productName" class="form-control mb-2" placeholder="å•†å“åç¨±">
      <input id="productPrice" type="number" class="form-control mb-2" placeholder="åƒ¹æ ¼">
      <textarea id="productDesc" class="form-control mb-2" placeholder="å•†å“æè¿°"></textarea>
      <input id="productImage" class="form-control mb-2" placeholder="åœ–ç‰‡ç¶²å€ (å¯ç©º)">
      <button class="btn btn-success" onclick="addProduct()">æ–°å¢å•†å“</button>
    </div>
    <div id="productsTable" class="table-responsive"></div>
  </div>
</div>

<script>
let token = "";

function login() {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  if (!username || !password) {
    alert("è«‹è¼¸å…¥å®Œæ•´å¸³è™Ÿå¯†ç¢¼");
    return;
  }
  token = btoa(`${username}:${password}`);
  loadOrders();
  loadProducts();
}

async function loadOrders() {
  const res = await fetch("/admin/orders", { headers: { "Authorization": "Basic " + token } });
  if (!res.ok) {
    alert("âŒ å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼");
    return;
  }
  const orders = await res.json();

  let html = `<table class="table table-striped table-bordered">
    <thead class="table-dark">
      <tr>
        <th>è¨‚å–®ç·¨è™Ÿ</th>
        <th>å•†å“å…§å®¹</th>
        <th>é‡‘é¡</th>
        <th>ç‹€æ…‹</th>
        <th>å»ºç«‹æ™‚é–“</th>
        <th>ä»˜æ¬¾æ™‚é–“</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>`;
  orders.forEach(o => {
    html += `<tr>
      <td>${o.order_id}</td>
      <td>${o.item_names}</td>
      <td>${o.amount}</td>
      <td>${o.status}</td>
      <td>${o.created_at}</td>
      <td>${o.paid_at || '-'}</td>
      <td>
        <select onchange="updateOrderStatus('${o.order_id}', this.value)" class="form-select form-select-sm">
          <option value="">--ä¿®æ”¹ç‹€æ…‹--</option>
          <option value="pending">pending</option>
          <option value="success">success</option>
          <option value="fail">fail</option>
        </select>
      </td>
    </tr>`;
  });
  html += "</tbody></table>";
  document.getElementById("ordersTable").innerHTML = html;
  document.getElementById("loginArea").classList.add("d-none");
  document.getElementById("ordersArea").classList.remove("d-none");
  document.getElementById("productsArea").classList.remove("d-none");
}

async function updateOrderStatus(orderId, newStatus) {
  if (!newStatus) return;
  const res = await fetch("/admin/update_order_status", {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": "Basic " + token },
    body: JSON.stringify({ order_id: orderId, status: newStatus })
  });
  const result = await res.json();
  alert(result.message || result.error);
  loadOrders();
}

async function loadProducts() {
  const res = await fetch("/products");
  const products = await res.json();

  let html = `<table class="table table-striped table-bordered">
    <thead class="table-dark">
      <tr>
        <th>åç¨±</th>
        <th>åƒ¹æ ¼</th>
        <th>æè¿°</th>
        <th>åœ–ç‰‡</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>`;
  products.forEach(p => {
    html += `<tr>
      <td><input class="form-control form-control-sm" value="${p.name}" data-id="${p.id}" data-field="name"></td>
      <td><input type="number" class="form-control form-control-sm" value="${p.price}" data-id="${p.id}" data-field="price"></td>
      <td><input class="form-control form-control-sm" value="${p.description || ''}" data-id="${p.id}" data-field="description"></td>
      <td><input class="form-control form-control-sm" value="${p.image_url || ''}" data-id="${p.id}" data-field="image_url"></td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">åˆªé™¤</button>
      <button class="btn btn-primary btn-sm" onclick="saveProduct(${p.id})">ä¿å­˜</button></td>
    </tr>`;
  });
  html += "</tbody></table>";
  document.getElementById("productsTable").innerHTML = html;
}

async function addProduct() {
  const name = document.getElementById("productName").value;
  const price = parseInt(document.getElementById("productPrice").value);
  const description = document.getElementById("productDesc").value;
  const image_url = document.getElementById("productImage").value;
  if (!name || !price) {
    alert("è«‹å¡«å¯«å®Œæ•´çš„å•†å“åç¨±èˆ‡åƒ¹æ ¼ï¼");
    return;
  }
  const res = await fetch("/admin/products", {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": "Basic " + token },
    body: JSON.stringify({ name, price, description, image_url })
  });
  const result = await res.json();
  alert(result.message || result.error);
  loadProducts();
}

async function saveProduct(id) {
  const inputs = document.querySelectorAll(`[data-id='${id}']`);
  const data = {};
  inputs.forEach(input => {
    data[input.getAttribute("data-field")] = input.value;
  });
  const res = await fetch(`/admin/products/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json", "Authorization": "Basic " + token },
    body: JSON.stringify(data)
  });
  const result = await res.json();
  alert(result.message || result.error);
  loadProducts();
}

async function deleteProduct(id) {
  if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹å•†å“ï¼Ÿ")) return;
  const res = await fetch(`/admin/products/${id}`, {
    method: "DELETE",
    headers: { "Authorization": "Basic " + token }
  });
  const result = await res.json();
  alert(result.message || result.error);
  loadProducts();
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
