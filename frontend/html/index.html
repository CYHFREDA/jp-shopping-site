<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>æ—¥æœ¬ä»£è³¼å•†åŸ</title>
<style>
  body {
    font-family: "Helvetica Neue", sans-serif;
    text-align: center;
    background-color: #f0f4f8;
    margin: 0;
    padding: 50px;
    color: #333;
  }

  h1 {
    color: #222;
    margin-bottom: 30px;
  }

  table {
    margin: 0 auto;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  th, td {
    border: 1px solid #ddd;
    padding: 10px 15px;
  }

  th {
    background-color: #00c300;
    color: white;
  }

  tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  input[type="text"], input[type="number"] {
    width: 100px;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
    text-align: center;
  }

  button {
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #00c300;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: background-color 0.3s, transform 0.2s;
  }

  button:hover {
    background-color: #00a300;
  }

  #addRowBtn {
    background-color: #007bff;
  }

  #addRowBtn:hover {
    background-color: #0056b3;
  }
</style>
</head>
<body>

<h1>æ—¥æœ¬ä»£è³¼å•†åŸ - æ–°å¢å•†å“</h1>

<table>
  <thead>
    <tr>
      <th>å•†å“åç¨±</th>
      <th>æ•¸é‡</th>
      <th>åƒ¹æ ¼</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody id="productTable">
    <tr>
      <td><input type="text" placeholder="å•†å“åç¨±" /></td>
      <td><input type="number" value="1" min="1" /></td>
      <td><input type="number" value="100" min="0" /></td>
      <td><button onclick="removeRow(this)" style="background: #dc3545;">åˆªé™¤</button></td>
    </tr>
  </tbody>
</table>

<button id="addRowBtn" onclick="addRow()">â• æ–°å¢å•†å“</button>
<button onclick="startPayment(event)">ç¶ ç•Œæ”¯ä»˜</button>

<script>
  function addRow() {
    const table = document.getElementById("productTable");
    const newRow = table.rows[0].cloneNode(true);
    // æ¸…ç©ºæ–°åˆ—çš„å€¼
    newRow.querySelectorAll("input").forEach(input => {
      if (input.type === "text") input.value = "";
      if (input.type === "number") input.value = 1;
    });
    table.appendChild(newRow);
  }

  function removeRow(button) {
    const row = button.closest("tr");
    const table = document.getElementById("productTable");
    if (table.rows.length > 1) {
      row.remove();
    } else {
      alert("âš ï¸ è‡³å°‘è¦ç•™ä¸€ç­†å•†å“å–”ï¼");
    }
  }

  function startPayment(event) {
    event.preventDefault();

    const rows = document.querySelectorAll("#productTable tr");
    const products = [];

    rows.forEach((row, idx) => {
      const name = row.cells[0].querySelector("input").value || "æœªå‘½åå•†å“";
      const quantity = parseInt(row.cells[1].querySelector("input").value) || 1;
      const price = parseInt(row.cells[2].querySelector("input").value) || 0;

      console.log(`ç¬¬${idx+1}åˆ—ï¼šåç¨±=${name}ï¼Œæ•¸é‡=${quantity}ï¼Œåƒ¹æ ¼=${price}`);

      if (price > 0) {
        products.push({ name, quantity, price });
      }
    });

    console.log("çµ„åˆå¾Œçš„å•†å“é™£åˆ—ï¼š", products);

    if (products.length === 0) {
      alert("âŒ è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æœ‰æ•ˆå•†å“ï¼");
      return;
    }

    // ğŸ”¥ æ”¹æˆè«‹æ±‚å¾Œç«¯ /payï¼Œæ‹¿åˆ° ecpay_url å’Œ params
    fetch("https://api.wvwwcw.xyz/pay", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ products })
    })
    .then(res => {
      if (!res.ok) {
        return res.json().then(err => { throw err; });
      }
      return res.json();
    })
    .then(data => {
      console.log("å¾Œç«¯å›å‚³ï¼š", data);

      if (data.ecpay_url && data.params) {
        // âœ… ç”¢ç”Ÿ form ä¸¦é€å‡ºåˆ°ç¶ ç•Œ
        const form = document.createElement("form");
        form.action = data.ecpay_url;
        form.method = "post";

        Object.entries(data.params).forEach(([key, value]) => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = key;
          input.value = value;
          form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
      } else {
        alert("âŒ ç™¼èµ·ä»˜æ¬¾å¤±æ•—ï¼");
        console.error(data);
      }
    })
    .catch(err => {
      alert("âŒ ç™¼èµ·ä»˜æ¬¾éŒ¯èª¤ï¼");
      console.error(err);
    });
  }
</script>

</body>
</html>