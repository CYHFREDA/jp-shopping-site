<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>購物車</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { background-color: #f1f3f5; }
  .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .card { border-radius: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
  footer { background-color: #212529; color: #adb5bd; padding: 1rem 0; font-size: 0.9rem; text-align: center; }
  .navbar-brand i { margin-right: 0.5rem; }
  .btn-success { background-color: #38ada9; border-color: #38ada9; }
  .btn-success:hover { background-color: #218c87; border-color: #218c87; }
  .btn-danger { background-color: #b71540; border-color: #b71540; }
  .btn-danger:hover { background-color: #a11235; border-color: #a11235; }
  .table th, .table td { vertical-align: middle; }
</style>
</head>

<body>
<!-- 🔹 導航列 -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="/"><i class="fa-solid fa-house"></i>商城首頁</a>
    <span class="navbar-text text-light">｜購物車</span>
  </div>
</nav>

<div class="container">
  <!-- 🔹 購物車卡片 -->
  <div class="card p-4 mb-4">
    <h4 class="mb-4 fw-bold text-center"><i class="fa-solid fa-cart-shopping"></i> 我的購物車</h4>
    <div class="table-responsive mb-3">
      <table class="table table-striped table-bordered align-middle bg-white">
        <thead class="table-dark">
          <tr>
            <th>商品名稱</th>
            <th>數量</th>
            <th>價格</th>
            <th>小計</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="cartBody"></tbody>
      </table>
    </div>
    <div class="text-end fw-bold my-3" id="totalAmount">總金額：0 元</div>
    <div class="text-center">
      <button class="btn btn-success btn-lg px-5" onclick="checkout()">
        <i class="fas fa-credit-card"></i> 結帳
      </button>
    </div>
  </div>
</div>

<footer class="mt-4">&copy; 2025 日本代購商城 | 聯絡我們: inulifegogo@gmail.com</footer>

<script>
  function loadCart() {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const tbody = document.getElementById("cartBody");
    tbody.innerHTML = "";
    let total = 0;

    cart.forEach((item, index) => {
      const subtotal = item.price * item.quantity;
      total += subtotal;
      const row = `
        <tr>
          <td>${item.name}</td>
          <td><input type="number" min="1" value="${item.quantity}" onchange="updateQuantity(${index}, this.value)" class="form-control form-control-sm"></td>
          <td>${item.price}</td>
          <td>${subtotal}</td>
          <td><button class="btn btn-danger btn-sm" onclick="removeItem(${index})"><i class="fas fa-trash"></i></button></td>
        </tr>
      `;
      tbody.insertAdjacentHTML("beforeend", row);
    });

    document.getElementById("totalAmount").textContent = `總金額：${total} 元`;
  }

  function updateQuantity(index, newQuantity) {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    cart[index].quantity = parseInt(newQuantity);
    localStorage.setItem("cart", JSON.stringify(cart));
    loadCart();
  }

  function removeItem(index) {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    cart.splice(index, 1);
    localStorage.setItem("cart", JSON.stringify(cart));
    loadCart();
  }

  function checkout() {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    if (cart.length === 0) {
      alert("❌ 購物車是空的！");
      return;
    }

    fetch("/pay", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ products: cart })
    })
    .then(res => res.json())
    .then(data => {
      if (data.ecpay_url && data.params) {
        localStorage.removeItem("cart");
        const form = document.createElement("form");
        form.action = data.ecpay_url;
        form.method = "post";
        Object.entries(data.params).forEach(([key, value]) => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = key;
          input.value = value;
          form.appendChild(input);
        });
        document.body.appendChild(form);
        form.submit();
      } else {
        alert("❌ 發起付款失敗！");
      }
    })
    .catch(err => {
      alert("❌ 發起付款錯誤！");
      console.error(err);
    });
  }

  loadCart();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
