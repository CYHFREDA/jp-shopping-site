from fastapi import APIRouter, Request, Depends
from fastapi.responses import JSONResponse, HTMLResponse
from db.db import get_db_cursor
from datetime import datetime
import random
import hashlib
import urllib.parse
import os
import jwt

router = APIRouter()

#ç¶ ç•Œæ¸¬è©¦ç’°å¢ƒè¨­å®š
ECPAY_MERCHANT_ID = os.getenv("ECPAY_MERCHANT_ID")
ECPAY_HASH_KEY = os.getenv("ECPAY_HASH_KEY")
ECPAY_HASH_IV = os.getenv("ECPAY_HASH_IV")
YOUR_DOMAIN = os.getenv("YOUR_DOMAIN")
ECPAY_API_URL = "https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5"

# ç”¢ç”Ÿ CheckMacValue
def generate_check_mac_value(params: dict, hash_key: str, hash_iv: str) -> str:
    sorted_params = sorted(params.items())
    encode_str = f"HashKey={hash_key}&" + '&'.join([f"{k}={v}" for k, v in sorted_params]) + f"&HashIV={hash_iv}"
    encode_str = urllib.parse.quote_plus(encode_str).lower()
    sha256 = hashlib.sha256()
    sha256.update(encode_str.encode('utf-8'))
    return sha256.hexdigest().upper()

# å»ºç«‹è¨‚å–®ä¸¦å–å¾—ç¶ ç•Œä»˜æ¬¾åƒæ•¸
@router.post("/pay")
async def pay(request: Request, cursor=Depends(get_db_cursor)):
    try:
        data = await request.json()
        print("âœ… æ”¶åˆ°å‰ç«¯è³‡æ–™ï¼š", data)

        products = data.get("products")
        customer_id = data.get("customer_id")

        if not products:
            return JSONResponse({"error": "âŒ ç¼ºå°‘å•†å“è³‡æ–™"}, status_code=400)
            
        if not customer_id:
            print("âš ï¸ æœªæ”¶åˆ° customer_idï¼Œè¨‚å–®å°‡ä¸æœƒé—œè¯åˆ°å®¢æˆ¶ã€‚")

        now = datetime.now()
        date_time_str = now.strftime("%Y%m%d%H%M%S")
        serial_number = f"{random.randint(0, 999999):06d}"
        order_id = f"{date_time_str}{serial_number}"

        amount = sum(item["price"] * item["quantity"] for item in products)
        item_names = "#".join([f"{item['name']} x {item['quantity']}" for item in products])
        trade_date = now.strftime("%Y/%m/%d %H:%M:%S")

        #å¯«å…¥è³‡æ–™åº«
        cursor.execute("""
            INSERT INTO orders (order_id, amount, item_names, status, created_at, customer_id)
            VALUES (%s, %s, %s, %s, %s, %s)
        """, (order_id, amount, item_names, 'pending', trade_date, customer_id))
        cursor.connection.commit()
        print("âœ… è¨‚å–®å·²å¯«å…¥è³‡æ–™åº«ï¼")

        # ç¶ ç•Œåƒæ•¸
        params = {
            "MerchantID": ECPAY_MERCHANT_ID,
            "MerchantTradeNo": order_id,
            "MerchantTradeDate": trade_date,
            "PaymentType": "aio",
            "TotalAmount": amount,
            "TradeDesc": "ç¶ ç•Œå¹³å°å•†æ¸¬è©¦",
            "ItemName": item_names,
            "ReturnURL": f"{YOUR_DOMAIN}/ecpay/notify",
            "ChoosePayment": "Credit",
            "ClientBackURL": f"{YOUR_DOMAIN}/pay/return",
            "PlatformID": ECPAY_MERCHANT_ID
        }
        params["CheckMacValue"] = generate_check_mac_value(params, ECPAY_HASH_KEY, ECPAY_HASH_IV)
        print("âœ… é€å‡ºçš„åƒæ•¸ï¼š", params)

        return JSONResponse({"ecpay_url": ECPAY_API_URL, "params": params, "order_id": order_id})

    except Exception as e:
        print("âŒ å¾Œç«¯éŒ¯èª¤ï¼š", str(e))
        return JSONResponse({"error": "å¾Œç«¯ç™¼ç”ŸéŒ¯èª¤"}, status_code=500)

# æ¥æ”¶ç¶ ç•Œä»˜æ¬¾çµæœ
@router.post("/ecpay/notify")
async def ecpay_notify(request: Request, cursor=Depends(get_db_cursor)):
    try:
        data = await request.form()
        print("âœ… æ”¶åˆ°ç¶ ç•Œé€šçŸ¥ï¼š", data)

        order_id = data.get("MerchantTradeNo")
        rtn_code = data.get("RtnCode")
        payment_date = data.get("PaymentDate", None)
        status_ = "success" if rtn_code == "1" else "fail"

        cursor.execute("UPDATE orders SET status=%s, paid_at=%s WHERE order_id=%s", (status_, payment_date, order_id))
        cursor.connection.commit()

        # ğŸŸ¢ æ–°å¢å‡ºè²¨è³‡æ–™ï¼ˆå¦‚æœè¨‚å–®æ˜¯æˆåŠŸä»˜æ¬¾ï¼‰
        if status_ == "success":
            # å…ˆæŸ¥è¨‚å–®çš„ customer_id
            cursor.execute("SELECT customer_id FROM orders WHERE order_id = %s", (order_id,))
            row = cursor.fetchone()
            customer_id = row[0] if row else None

            recipient_name = 'å¾…å¡«å¯«'
            address = 'å¾…å¡«å¯«'
            if customer_id:
                cursor.execute("SELECT name, address FROM customers WHERE customer_id = %s", (customer_id,))
                customer = cursor.fetchone()
                if customer:
                    recipient_name, address = customer

            cursor.execute("""
                INSERT INTO shipments (order_id, recipient_name, address, status, created_at)
                VALUES (%s, %s, %s, %s, NOW())
            """, (order_id, recipient_name, address, 'pending'))
            cursor.connection.commit()
            print(f"âœ… å‡ºè²¨å–®å·²è‡ªå‹•å»ºç«‹ï¼Œorder_id: {order_id}, recipient: {recipient_name}, address: {address}")

        print(f"âœ… è¨‚å–® {order_id} ç‹€æ…‹å·²æ›´æ–°ç‚ºï¼š{status_}")

        return HTMLResponse("1|OK")
    except Exception as e:
        print("âŒ /ecpay/notify ç™¼ç”ŸéŒ¯èª¤ï¼š", str(e))
        return HTMLResponse("0|Error")
