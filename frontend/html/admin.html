<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>å¾Œå°è¨‚å–®ç®¡ç†</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<!-- å°è¦½åˆ— -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="/index.html">ğŸ”™ å›åˆ°å•†åŸé¦–é </a>
    <span class="navbar-text text-white">ï½œå¾Œå°è¨‚å–®ç®¡ç†</span>
  </div>
</nav>

<div class="container py-4">
  <!-- ç™»å…¥å€å¡Š -->
  <div id="loginArea" class="mb-4">
    <h4>è«‹è¼¸å…¥å¾Œå°å¸³è™Ÿå¯†ç¢¼ï¼š</h4>
    <input id="username" class="form-control mb-2" placeholder="Username" />
    <input id="password" type="password" class="form-control mb-2" placeholder="Password" />
    <button class="btn btn-primary" onclick="login()">ç™»å…¥</button>
  </div>

  <!-- è¨‚å–®ç®¡ç†å€å¡Š -->
  <div id="ordersArea" class="d-none">
    <div id="ordersTable" class="table-responsive"></div>
  </div>
</div>

<script>
  let token = "";

  function login() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    if (!username || !password) {
      alert("è«‹è¼¸å…¥å®Œæ•´å¸³è™Ÿå¯†ç¢¼");
      return;
    }

    token = btoa(`${username}:${password}`);
    loadOrders();
  }

  async function loadOrders() {
    const res = await fetch("/admin/orders", {
      headers: { "Authorization": "Basic " + token }
    });
    if (!res.ok) {
      alert("âŒ å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼");
      return;
    }
    const orders = await res.json();

    let html = `
      <table class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            <th>è¨‚å–®ç·¨è™Ÿ</th>
            <th>å•†å“å…§å®¹</th>
            <th>é‡‘é¡</th>
            <th>ç‹€æ…‹</th>
            <th>å»ºç«‹æ™‚é–“</th>
            <th>ä»˜æ¬¾æ™‚é–“</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
    `;

    orders.forEach(o => {
      html += `
        <tr>
          <td>${o.order_id}</td>
          <td>${o.item_names}</td>
          <td>${o.amount}</td>
          <td>${o.status}</td>
          <td>${o.created_at}</td>
          <td>${o.paid_at || '-'}</td>
          <td>
            <select onchange="updateStatus('${o.order_id}', this.value)" class="form-select form-select-sm">
              <option value="">--ä¿®æ”¹ç‹€æ…‹--</option>
              <option value="pending">pending</option>
              <option value="success">success</option>
              <option value="fail">fail</option>
            </select>
          </td>
        </tr>
      `;
    });

    html += "</tbody></table>";
    document.getElementById("ordersTable").innerHTML = html;

    // åˆ‡æ›ç•«é¢ï¼šéš±è—ç™»å…¥ã€é¡¯ç¤ºè¨‚å–®
    document.getElementById("loginArea").classList.add("d-none");
    document.getElementById("ordersArea").classList.remove("d-none");
  }

  async function updateStatus(orderId, newStatus) {
    if (!newStatus) return;

    const res = await fetch("/admin/update_order_status", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Basic " + token
      },
      body: JSON.stringify({ order_id: orderId, status: newStatus })
    });
    const result = await res.json();
    alert(result.message || result.error);
    loadOrders();
  }
</script>

</body>
</html>
