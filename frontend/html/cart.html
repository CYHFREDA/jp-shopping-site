<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>購物車</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  footer { background-color: #343a40; color: #fff; padding: 0.75rem 0; text-align: center; font-size: 0.9rem; }
</style>
</head>

<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
  <div class="container-fluid">
    <a class="navbar-brand" href="/"><i class="fa-solid fa-house"></i>商城首頁</a>
    <span class="navbar-text text-white">｜購物車</span>
  </div>
</nav>

<div class="container py-4">
  <h2 class="text-center mb-4">🛒 購物車</h2>

  <div class="table-responsive shadow-sm">
    <table class="table table-bordered align-middle bg-white">
      <thead class="table-dark">
        <tr>
          <th>商品名稱</th>
          <th>數量</th>
          <th>價格</th>
          <th>小計</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="cartBody"></tbody>
    </table>
  </div>

  <div class="text-end fw-bold my-3" id="totalAmount">總金額：0 元</div>

  <div class="text-center">
    <button class="btn btn-success" onclick="checkout()">結帳</button>
  </div>
</div>

<footer class="mt-4">&copy; 2025 日本代購商城</footer>

<script>
  function loadCart() {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const tbody = document.querySelector("#cartTable tbody");
    tbody.innerHTML = "";
    let total = 0;

    cart.forEach((item, index) => {
      const subtotal = item.price * item.quantity;
      total += subtotal;
      const row = `
        <tr>
          <td>${item.name}</td>
          <td><input type="number" min="1" value="${item.quantity}" onchange="updateQuantity(${index}, this.value)" class="form-control"></td>
          <td>${item.price}</td>
          <td>${subtotal}</td>
          <td><button class="btn btn-danger" onclick="removeItem(${index})">刪除</button></td>
        </tr>
      `;
      tbody.insertAdjacentHTML("beforeend", row);
    });

    document.getElementById("totalAmount").textContent = `總金額：${total} 元`;
  }

  function updateQuantity(index, newQuantity) {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    cart[index].quantity = parseInt(newQuantity);
    localStorage.setItem("cart", JSON.stringify(cart));
    loadCart();
  }

  function removeItem(index) {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    cart.splice(index, 1);
    localStorage.setItem("cart", JSON.stringify(cart));
    loadCart();
  }

  function checkout() {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    if (cart.length === 0) {
      alert("❌ 購物車是空的！");
      return;
    }

    fetch("/pay", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ products: cart })
    })
    .then(res => res.json())
    .then(data => {
      if (data.ecpay_url && data.params) {
        localStorage.removeItem("cart"); // 清空購物車
        const form = document.createElement("form");
        form.action = data.ecpay_url;
        form.method = "post";
        Object.entries(data.params).forEach(([key, value]) => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = key;
          input.value = value;
          form.appendChild(input);
        });
        document.body.appendChild(form);
        form.submit();
      } else {
        alert("❌ 發起付款失敗！");
      }
    })
    .catch(err => {
      alert("❌ 發起付款錯誤！");
      console.error(err);
    });
  }

  loadCart();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>